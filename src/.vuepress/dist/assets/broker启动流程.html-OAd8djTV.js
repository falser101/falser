import{_ as n}from"./plugin-vue_export-helper-x3n3nnut.js";import{o as s,c as a,f as t}from"./app-LEHJ93_Z.js";const p="/falser/imgs/pulsar/broker-startup/æ€»ä½“å¯åŠ¨æµç¨‹.png",e={},o=t('<h1 id="brokerç»„ä»¶å¯åŠ¨æµç¨‹" tabindex="-1"><a class="header-anchor" href="#brokerç»„ä»¶å¯åŠ¨æµç¨‹" aria-hidden="true">#</a> Brokerç»„ä»¶å¯åŠ¨æµç¨‹</h1><p>åœ¨æ”¶å‘æ¶ˆæ¯å‰ï¼Œæˆ‘ä»¬å¾—å¯åŠ¨BrokeræœåŠ¡ï¼Œæœ¬ç« å°†ä»‹ç»Brokeråœ¨å¯åŠ¨é˜¶æ®µéƒ½åšäº†ä»€ä¹ˆã€‚å„ä¸ªæ¨¡å—ä¹‹å‰çš„å…³ç³»ï¼ŒæœåŠ¡å¯åŠ¨ä¸åŒæ¨¡å—çš„åˆå§‹åŒ–é¡ºåºã€‚</p><h2 id="æœåŠ¡å¯åŠ¨" tabindex="-1"><a class="header-anchor" href="#æœåŠ¡å¯åŠ¨" aria-hidden="true">#</a> æœåŠ¡å¯åŠ¨</h2><p>ä½¿ç”¨binç›®å½•ä¸‹åä¸ºpulsarçš„CLIå·¥å…·ï¼Œæ‰§è¡Œå‘½ä»¤æ—¶ä¼ å…¥brokerå‚æ•°ï¼Œä¼šè°ƒç”¨<code>PulsarBrokerStarter</code>è¿™ä¸ªç±»æ¥å¯åŠ¨Pulsar BrokeræœåŠ¡ã€‚Brokeræ€»ä½“å¯åŠ¨æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤º:</p><figure><img src="'+p+`" alt="pulsar-broker-startup" tabindex="0" loading="lazy"><figcaption>pulsar-broker-startup</figcaption></figure><ol><li><p>åŠ è½½é…ç½®æ–‡ä»¶ã€‚Brokerå¯åŠ¨æ—¶ä¼šè¯»å–conf/broker.confæ–‡ä»¶ï¼Œå¹¶å°†å…¶ä¸­çš„é…ç½®ä¿¡æ¯å…¨éƒ¨è½¬åŒ–ä¸ºKey/Valueçš„å½¢å¼ï¼Œé€šè¿‡åå°„åˆ›å»ºä¸€ä¸ª<code>ServiceConfigration</code>å¯¹è±¡ã€‚å¹¶ä¸”æŠŠå€¼è®¾ç½®åˆ°è¿™ä¸ªå¯¹è±¡çš„å±æ€§ä¸­ã€‚</p></li><li><p>æ³¨å†ŒShutdownHookå’ŒOOMç›‘å¬å™¨ã€‚ShutdownHookåœ¨æœåŠ¡å…³é—­æ—¶æ‰§è¡Œæ¸…ç†ğŸ’°ï¼ŒOOMListeneråœ¨å†…å­˜æº¢å‡ºæ—¶æ‰“å°å¼‚å¸¸ä¿¡æ¯ã€‚</p></li><li><p>å¯åŠ¨<code>BookieStatsProvider</code>æœåŠ¡,<code>BookieStatsProvider</code>æ˜¯BookieæœåŠ¡çš„ç»Ÿè®¡ä¿¡æ¯æä¾›è€…ï¼Œæä¾›BookieæœåŠ¡çš„ç»Ÿè®¡ä¿¡æ¯ã€‚è¿™ä¸€æ­¥é€šå¸¸åªåœ¨Standaloneæ¨¡å¼ä¸‹æ‰§è¡Œã€‚</p></li><li><p>å¯åŠ¨BookieServer,è®©Bookieå’ŒBrokerä¸€èµ·å¯åŠ¨ï¼Œä¸»è¦ç”¨äºå¼€å‘æµ‹è¯•</p></li><li><p>å¯åŠ¨<code>PulsarService</code>æœåŠ¡ï¼Œ<code>PulsarService</code>æ˜¯å¯åŠ¨Brokerçš„ä¸»å…¥å£ï¼Œå†…éƒ¨è¿˜ä¼šå¯åŠ¨ä¸€ä¸ª<code>BrokerService</code>ï¼Œè¿™ä¸¤ä¸ªServiceçš„åˆ†å·¥ä¸åŒï¼Œ<code>PulsarService</code>èŒƒå›´æ›´å¤§ï¼ŒåŒ…æ‹¬è´Ÿè½½ç®¡ç†ã€ç¼“å­˜ã€Schemaã€Adminç›¸å…³çš„WebæœåŠ¡ç­‰ï¼Œå±äºç®¡ç†æµã€‚è€Œ<code>BrokerService</code>åˆ™ä¸“æ³¨äºæ¶ˆæ¯çš„æ”¶å‘ï¼Œåˆ›å»º<code>Netty EventLoopGroup</code>ã€åˆ›å»ºå†…ç½®è°ƒåº¦å™¨ç­‰ï¼Œå±äºæ•°æ®æµã€‚</p></li></ol><blockquote><p>ä»€ä¹ˆæ˜¯ç®¡ç†æµå’Œæ•°æ®æµï¼Ÿ</p><p>å¢åˆ æ”¹æŸ¥Brokerçš„é…ç½®ï¼Œæˆ–è€…ä¸€ä¸ªTopicï¼Œé€šè¿‡Pulsar-Adminæ¥æ“ä½œï¼Œè¿™äº›æ“ä½œéƒ½æ˜¯ç®¡ç†æµã€‚ æ”¶å‘æ¶ˆæ¯ï¼Œè¿™äº›æ“ä½œéƒ½æ˜¯æ•°æ®æµã€‚æ‰§è¡Œæ“ä½œä¹‹å‰ï¼Œéœ€è¦é€šè¿‡PulsarClientæ¥åˆ›å»ºProducerå’ŒConsumerï¼Œç„¶åæ‰èƒ½æ‰§è¡Œæ”¶å‘æ¶ˆæ¯çš„æ“ä½œã€‚</p></blockquote><p>ä¸»è¦ä»£ç å¦‚ä¸‹ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token class-name">BrokerStarter</span> starter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrokerStarter</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addShutdownHook</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">PulsarByteBufAllocator</span><span class="token punctuation">.</span><span class="token function">registerOOMListener</span><span class="token punctuation">(</span>oomException <span class="token operator">-&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        starter<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

# åŠ è½½é…ç½®æ–‡ä»¶
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ServiceConfiguration</span> <span class="token function">loadConfig</span><span class="token punctuation">(</span><span class="token class-name">String</span> configFile<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>configFile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ServiceConfiguration</span> config <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">,</span> <span class="token class-name">ServiceConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// it validates provided configuration is completed</span>
        <span class="token function">isComplete</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> config<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

# å¯åŠ¨æœåŠ¡
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bookieStatsProvider <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bookieStatsProvider<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>bookieConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;started bookieStatsProvider.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bookieServer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bookieStartFuture <span class="token operator">=</span> <span class="token class-name">ComponentStarter</span><span class="token punctuation">.</span><span class="token function">startComponent</span><span class="token punctuation">(</span>bookieServer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;started bookieServer.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>autoRecoveryMain <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        autoRecoveryMain<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;started bookie autoRecoveryMain.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    pulsarService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;PulsarService started.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="pulsarservice" tabindex="-1"><a class="header-anchor" href="#pulsarservice" aria-hidden="true">#</a> PulsarService</h2><p>ä¸»è¦ä»£ç å¦‚ä¸‹ï¼ˆçœç•¥äº†ä¸€äº›ä¸é‡è¦çš„ä»£ç ï¼‰ï¼š</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">PulsarServerException</span> <span class="token punctuation">{</span>
    mutex<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        localMetadataSynchronizer <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getMetadataSyncEventTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">PulsarMetadataEventSynchronizer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> config<span class="token punctuation">.</span><span class="token function">getMetadataSyncEventTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        localMetadataStore <span class="token operator">=</span> <span class="token function">createLocalMetadataStore</span><span class="token punctuation">(</span>localMetadataSynchronizer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        localMetadataStore<span class="token punctuation">.</span><span class="token function">registerSessionListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">handleMetadataSessionEvent</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// åˆ›å»ºcoordinationServiceï¼Œç”¨äºåˆ†å¸ƒå¼é”ã€Brokeré€‰ä¸»ç­‰</span>
        coordinationService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CoordinationServiceImpl</span><span class="token punctuation">(</span>localMetadataStore<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// åˆ›å»ºpulsarResourcesï¼Œç”¨äºå…ƒæ•°æ®ç®¡ç†ï¼Œå…ƒæ•°æ®åŒ…æ‹¬æœ¬åœ°å…ƒæ•°æ®å’Œé…ç½®æ–‡ä»¶å…ƒæ•°æ®ï¼Œä¿å­˜åœ¨zookeeperä¸­</span>
        pulsarResources <span class="token operator">=</span> <span class="token function">newPulsarResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// åˆ›å»ºorderedExecutorçº¿ç¨‹æ± ï¼Œåç»­ç”¨äºZKçš„æ“ä½œï¼Œæ‹†åˆ†bundleç­‰</span>
        orderedExecutor <span class="token operator">=</span> <span class="token function">newOrderedExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// åˆ›å»ºprotocolHandlersï¼Œè¿™ä¸ªæœåŠ¡ç”¨äºç®¡ç†pulsarçš„æ‰©å±•ç‚¹ï¼Œpulsarä¸­å¯ä»¥é€šè¿‡*.naræ–‡ä»¶å®ç°è‡ªå®šä¹‰æ‰©å±•ç‚¹ã€‚</span>
        <span class="token comment">// Pulsarå¯åŠ¨æ—¶ä¼šé»˜è®¤å°è¯•æ‰«æ./protocolsç›®å½•æˆ–ç³»ç»Ÿç¯å¢ƒå˜é‡java.io.tmpdiré‡Œè®¾ç½®çš„è·¯å¾„ä¸‹çš„æ‰€æœ‰naræ–‡ä»¶ã€‚</span>
        <span class="token comment">// å¦‚KOPã€AOPç­‰éƒ½æ˜¯é€šè¿‡è¿™ä¸ªæ‰©å±•ç‚¹å®ç°çš„</span>
        protocolHandlers <span class="token operator">=</span> <span class="token class-name">ProtocolHandlers</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        protocolHandlers<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Now we are ready to start services</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>bkClientFactory <span class="token operator">=</span> <span class="token function">newBookKeeperClientFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// åˆ›å»ºManagedLedgerClientFactoryï¼Œç”¨äºç®¡ç†ManagedLedgerçš„å®¢æˆ·ç«¯ã€‚</span>
        <span class="token comment">// Pulsaræ˜¯è®¡ç®—å’Œå­˜å‚¨åˆ†ç¦»çš„æ¶æ„ï¼ŒmanagedLedgeræ˜¯å­˜å‚¨çš„æŠ½è±¡ï¼ŒManagedLedgerClientç”¨æ¥è¯·æ±‚BookKeeperä¿å­˜æ•°æ®</span>
        managedLedgerClientFactory <span class="token operator">=</span> <span class="token function">newManagedLedgerClientFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// åˆ›å»ºBrokerService, æ•°æ®æµç›¸å…³çš„æœåŠ¡éƒ½åœ¨è¿™é‡Œå¯åŠ¨</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>brokerService <span class="token operator">=</span> <span class="token function">newBrokerService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// åˆ›å»ºloadManagerï¼Œç”¨äºç®¡ç†brokerçš„è´Ÿè½½ï¼Œä¸ç®¡æœ‰æ²¡æœ‰æ‰“å¼€è‡ªåŠ¨è´Ÿè½½ç®¡ç†éƒ½ä¼šåˆ›å»º</span>
        <span class="token comment">// é»˜è®¤ç®¡ç†å™¨æ˜¯org.apache.pulsar.broker.loadbalance.impl.ModularLoadManagerImpl</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>loadManager<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">LoadManager</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// needs load management service and before start broker service,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startNamespaceService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        schemaStorage <span class="token operator">=</span> <span class="token function">createAndStartSchemaStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ç”¨äºç®¡ç†Topicçš„Schemaï¼Œå¦‚Schema.Type.JSON</span>
        schemaRegistryService <span class="token operator">=</span> <span class="token class-name">SchemaRegistryService</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>
                schemaStorage<span class="token punctuation">,</span> config<span class="token punctuation">.</span><span class="token function">getSchemaRegistryCompatibilityCheckers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>executor<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">OffloadPoliciesImpl</span> defaultOffloadPolicies <span class="token operator">=</span>
                <span class="token class-name">OffloadPoliciesImpl</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">OrderedScheduler</span> offloaderScheduler <span class="token operator">=</span> <span class="token function">getOffloaderScheduler</span><span class="token punctuation">(</span>defaultOffloadPolicies<span class="token punctuation">)</span><span class="token punctuation">;</span>

        offloaderStats <span class="token operator">=</span> <span class="token class-name">LedgerOffloaderStats</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">isExposeManagedLedgerMetricsInPrometheus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                exposeTopicMetrics<span class="token punctuation">,</span> offloaderScheduler<span class="token punctuation">,</span> interval<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// åˆ›å»ºOffloaderManagerï¼Œå½“æœ‰å¤§é‡çš„æ¶ˆæ¯å †ç§¯ï¼Œè¿™äº›æ¶ˆæ¯è¦æ±‚ä¿ç•™å¾ˆé•¿æ—¶é—´ï¼Œæˆ‘ä»¬ä¸æƒ³è®©è¿™äº›å†·æ•°æ®å ç”¨çº¿ä¸ŠæœåŠ¡çš„ç¡¬ç›˜ç©ºé—´ã€‚</span>
        <span class="token comment">// è¿™äº›å†·æ•°æ®å¯ä»¥ä½¿ç”¨OffloaderManagerç§»åŠ¨åˆ°å…¶ä»–ç£ç›˜ä¸Šï¼Œä»¥èŠ‚çœç©ºé—´ã€‚</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>defaultOffloader <span class="token operator">=</span> <span class="token function">createManagedLedgerOffloader</span><span class="token punctuation">(</span>defaultOffloadPolicies<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">setBrokerInterceptor</span><span class="token punctuation">(</span><span class="token function">newBrokerInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// use getter to support mocking getBrokerInterceptor method in tests</span>
        <span class="token class-name">BrokerInterceptor</span> interceptor <span class="token operator">=</span> <span class="token function">getBrokerInterceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>interceptor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            brokerService<span class="token punctuation">.</span><span class="token function">setInterceptor</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            interceptor<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// å¯åŠ¨brokerService</span>
        brokerService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Load additional servlets</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>brokerAdditionalServlets <span class="token operator">=</span> <span class="token class-name">AdditionalServlets</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// åˆ›å»ºç®¡ç†æµWebServiceï¼Œå¹¶å¯åŠ¨</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>webService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">createMetricsServlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addWebServerHandlers</span><span class="token punctuation">(</span>webService<span class="token punctuation">,</span> metricsServlet<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>webService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment">// å¯åŠ¨Leaderé€‰ä¸¾æœåŠ¡</span>
        <span class="token function">startLeaderElectionService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// å¯åŠ¨LoadManagementService</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startLoadManagementService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Initialize namespace service, after service url assigned. Should init zk and refresh self owner info.</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>nsService<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ä¸»é¢˜ç­–ç•¥æœåŠ¡ï¼Œè®©ç”¨æˆ·å¯ä»¥è®¾ç½®ä¸»é¢˜çº§åˆ«çš„ç­–ç•¥</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">isTopicLevelPoliciesEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> config<span class="token punctuation">.</span><span class="token function">isSystemTopicEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>topicPoliciesService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SystemTopicBasedTopicPoliciesService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>topicPoliciesService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Register heartbeat and bootstrap namespaces.</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>nsService<span class="token punctuation">.</span><span class="token function">registerBootstrapNamespaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// äº‹åŠ¡ç›¸å…³æœåŠ¡</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">isTransactionCoordinatorEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">MLTransactionMetadataStoreProvider</span><span class="token punctuation">.</span><span class="token function">initBufferedWriterMetrics</span><span class="token punctuation">(</span><span class="token function">getAdvertisedAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">MLPendingAckStoreProvider</span><span class="token punctuation">.</span><span class="token function">initBufferedWriterMetrics</span><span class="token punctuation">(</span><span class="token function">getAdvertisedAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>transactionBufferSnapshotServiceFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionBufferSnapshotServiceFactory</span><span class="token punctuation">(</span><span class="token function">getClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>transactionTimer <span class="token operator">=</span>
                    <span class="token keyword">new</span> <span class="token class-name">HashedWheelTimer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultThreadFactory</span><span class="token punctuation">(</span><span class="token string">&quot;pulsar-transaction-timer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            transactionBufferClient <span class="token operator">=</span> <span class="token class-name">TransactionBufferClientImpl</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> transactionTimer<span class="token punctuation">,</span>
                    config<span class="token punctuation">.</span><span class="token function">getTransactionBufferClientMaxConcurrentRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    config<span class="token punctuation">.</span><span class="token function">getTransactionBufferClientOperationTimeoutInMills</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            transactionMetadataStoreService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransactionMetadataStoreService</span><span class="token punctuation">(</span><span class="token class-name">TransactionMetadataStoreProvider</span>
                    <span class="token punctuation">.</span><span class="token function">newProvider</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getTransactionMetadataStoreProviderClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
                    transactionBufferClient<span class="token punctuation">,</span> transactionTimer<span class="token punctuation">)</span><span class="token punctuation">;</span>

            transactionBufferProvider <span class="token operator">=</span> <span class="token class-name">TransactionBufferProvider</span>
                    <span class="token punctuation">.</span><span class="token function">newProvider</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getTransactionBufferProviderClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            transactionPendingAckStoreProvider <span class="token operator">=</span> <span class="token class-name">TransactionPendingAckStoreProvider</span>
                    <span class="token punctuation">.</span><span class="token function">newProvider</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getTransactionPendingAckStoreProviderClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// åˆå§‹åŒ–metricsGeneratorï¼Œç”¨äºå°†ç”ŸæˆBrokerçº§åˆ«çš„metricsæš´éœ²ç»™Prometheus</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>metricsGenerator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MetricsGenerator</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Initialize the message protocol handlers.</span>
        <span class="token comment">// start the protocol handlers only after the broker is ready,</span>
        <span class="token comment">// so that the protocol handlers can access broker service properly.</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>protocolHandlers<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>brokerService<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">InetSocketAddress</span><span class="token punctuation">,</span> <span class="token class-name">ChannelInitializer</span><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> protocolHandlerChannelInitializers <span class="token operator">=</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>protocolHandlers<span class="token punctuation">.</span><span class="token function">newChannelInitializers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>brokerService<span class="token punctuation">.</span><span class="token function">startProtocolHandlers</span><span class="token punctuation">(</span>protocolHandlerChannelInitializers<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">acquireSLANamespace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// åˆ›å»ºå¹¶å¯åŠ¨function workeræœåŠ¡</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startWorkerService</span><span class="token punctuation">(</span>brokerService<span class="token punctuation">.</span><span class="token function">getAuthenticationService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> brokerService<span class="token punctuation">.</span><span class="token function">getAuthorizationService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// åˆ›å»ºå¹¶å¯åŠ¨packages managementæœåŠ¡,ç”¨äºç®¡ç†Functionçš„ç”¨æˆ·ä¸Šä¼ çš„ä»£ç åŒ…</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">isEnablePackagesManagement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startPackagesManagementService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="brokerservice" tabindex="-1"><a class="header-anchor" href="#brokerservice" aria-hidden="true">#</a> BrokerService</h2><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">BrokerService</span><span class="token punctuation">(</span><span class="token class-name">PulsarService</span> pulsar<span class="token punctuation">,</span> <span class="token class-name">EventLoopGroup</span> eventLoopGroup<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// åˆ›å»ºtopicOrderedExecutorï¼Œè¿™æ˜¯ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œç”±bookkeeperå°è£…ï¼Œä¿è¯åŒä¸€ä¸ªTopicåï¼Œ</span>
    <span class="token comment">// æ°¸è¿œä½¿ç”¨åŒä¸€ä¸ªçº¿ç¨‹æ¥æ‰§è¡Œï¼Œä»è€Œä¿è¯åŒä¸€ä¸ªtopicçš„æ“ä½œæ˜¯æœ‰åºçš„</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>topicOrderedExecutor <span class="token operator">=</span> <span class="token class-name">OrderedExecutor</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">numThreads</span><span class="token punctuation">(</span>pulsar<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTopicOrderedExecutorThreadNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;broker-topic-workers&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ä½¿ç”¨Nettyåˆ›å»ºacceptorGroupå¤„ç†I/Oäº‹ä»¶</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>acceptorGroup <span class="token operator">=</span> <span class="token class-name">EventLoopUtil</span><span class="token punctuation">.</span><span class="token function">newEventLoopGroup</span><span class="token punctuation">(</span>
                pulsar<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getNumAcceptorThreads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> acceptorThreadFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ä½¿ç”¨Nettyåˆ›å»ºworkerGroupå¤„ç†ä¸šåŠ¡é€»è¾‘</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>workerGroup <span class="token operator">=</span> eventLoopGroup<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment">// Pulsaræƒé™æ ¡éªŒï¼Œæ”¯æŒProduceï¼ŒConsumeã€Functionä¸‰ç§æƒé™</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>authorizationService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AuthorizationService</span><span class="token punctuation">(</span>
                pulsar<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">pulsar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPulsarResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åˆ›å»ºå„ç§ç›‘è§†å™¨</span>
    <span class="token comment">// å®šæœŸæ£€æŸ¥é•¿æœŸæœªä½¿ç”¨çš„ä¸»é¢˜å¹¶åˆ é™¤</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>inactivityMonitor <span class="token operator">=</span> <span class="token class-name">OrderedScheduler</span><span class="token punctuation">.</span><span class="token function">newSchedulerBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">&quot;pulsar-inactivity-monitor&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">numThreads</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å®šæœŸæ£€æŸ¥è¿‡æœŸæ¶ˆæ¯å¹¶åˆ é™¤</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>messageExpiryMonitor <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// å®šæœŸå‹ç¼©ä¸»é¢˜</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>compactionMonitor <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>consumedLedgersMonitor <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>backlogQuotaManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BacklogQuotaManager</span><span class="token punctuation">(</span>pulsar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// backlogæ£€æŸ¥å™¨</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>backlogQuotaChecker <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// è®¤è¯æœåŠ¡</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AuthenticationService</span><span class="token punctuation">(</span>pulsar<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// åˆ›å»ºåŠ¨æ€é…ç½®çš„ç›‘å¬å™¨</span>
    <span class="token function">updateConfigurationAndRegisterListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ä¸€äº›ä¿¡å·é‡</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>lookupRequestSemaphore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Semaphore</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span>pulsar<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxConcurrentLookupRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>topicLoadRequestSemaphore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Semaphore</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span>pulsar<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxConcurrentTopicLoadRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pulsar<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxUnackedMessagesPerBroker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span>
            <span class="token operator">&amp;&amp;</span> pulsar<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxUnackedMessagesPerSubscriptionOnBrokerBlocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// æœ€å¤§æœªç¡®è®¤æ¶ˆæ¯æ•°</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maxUnackedMessages <span class="token operator">=</span> pulsar<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxUnackedMessagesPerBroker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maxUnackedMsgsPerDispatcher <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>maxUnackedMessages
                <span class="token operator">*</span> pulsar<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxUnackedMessagesPerSubscriptionOnBrokerBlocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maxUnackedMessages <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maxUnackedMsgsPerDispatcher <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Pulsarçš„å»¶è¿Ÿæ¶ˆæ¯çš„å®ç°ç±»ä¼šé€šè¿‡è¿™ä¸ªå·¥å‚åˆ›å»ºå‡ºæ¥</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>delayedDeliveryTrackerFactory <span class="token operator">=</span> <span class="token class-name">DelayedDeliveryTrackerLoader</span>
        <span class="token punctuation">.</span><span class="token function">loadDelayedDeliveryTrackerFactory</span><span class="token punctuation">(</span>pulsar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Entryå…ƒæ•°æ®çš„æ‹¦æˆªå™¨ï¼Œç”¨äºç”¨æˆ·è‡ªå®šä¹‰æ‰©å±•</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>brokerEntryMetadataInterceptors <span class="token operator">=</span> <span class="token class-name">BrokerEntryMetadataUtils</span>
        <span class="token punctuation">.</span><span class="token function">loadBrokerEntryMetadataInterceptors</span><span class="token punctuation">(</span>pulsar<span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBrokerEntryMetadataInterceptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">BrokerService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,14),c=[o];function i(l,u){return s(),a("div",null,c)}const d=n(e,[["render",i],["__file","brokerå¯åŠ¨æµç¨‹.html.vue"]]);export{d as default};
