import{_ as l}from"./plugin-vue_export-helper-x3n3nnut.js";import{r as o,o as i,c as p,a as n,b as a,e,f as t}from"./app-7k_SbfeC.js";const r="/falser/imgs/k8s/2024/2024-06-28-14-04-46-image.png",c="/falser/imgs/k8s/2024/2024-06-28-14-06-34-image.png",u="/falser/imgs/k8s/2024/2024-06-28-14-05-52-image.png",d={},k=n("h1",{id:"grafana-loki-promtail",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#grafana-loki-promtail","aria-hidden":"true"},"#"),a(" Grafana Loki Promtail")],-1),m=n("p",null,[a("传统的日志收集框架如ELK（Logstash + Elasticsearch + Kibana）太过重量级，如果需求复杂，服务器资源不受限制，推荐使用ELK（"),n("code",null,"Logstash + Elasticsearch + Kibana"),a("）方案；如果需求仅是将不同服务器上的日志采集上来集中展示，且需要一个轻量级的框架，那使用PLG（"),n("code",null,"Promtail + Loki + Grafana"),a("）最合适不过了")],-1),v=n("p",null,"各组件官网地址",-1),h={href:"https://grafana.com/docs/loki/latest/",target:"_blank",rel:"noopener noreferrer"},b={href:"https://grafana.com/docs/loki/latest/send-data/promtail/",target:"_blank",rel:"noopener noreferrer"},f={href:"https://grafana.com/docs/grafana/latest/",target:"_blank",rel:"noopener noreferrer"},g=n("h2",{id:"下载安装包",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#下载安装包","aria-hidden":"true"},"#"),a(" 下载安装包")],-1),_={href:"https://github.com/grafana/loki/releases/download/v2.9.8/loki-linux-amd64.zip",target:"_blank",rel:"noopener noreferrer"},y={href:"https://github.com/grafana/loki/releases/download/v2.9.8/promtail-linux-amd64.zip",target:"_blank",rel:"noopener noreferrer"},x=t(`<div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">unzip</span> loki-linux-amd64.zip
<span class="token function">unzip</span> promtail-linux-amd64.zip
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="配置" tabindex="-1"><a class="header-anchor" href="#配置" aria-hidden="true">#</a> 配置</h2>`,2),L={href:"https://grafana.com/docs/loki/latest/configure/examples/configuration-examples/",target:"_blank",rel:"noopener noreferrer"},z=t(`<div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">auth_enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">http_listen_port</span><span class="token punctuation">:</span> <span class="token number">3100</span> <span class="token comment"># 服务监听端口</span>

<span class="token key atrule">common</span><span class="token punctuation">:</span>
  <span class="token key atrule">ring</span><span class="token punctuation">:</span>
    <span class="token key atrule">instance_addr</span><span class="token punctuation">:</span> 127.0.0.1
    <span class="token key atrule">kvstore</span><span class="token punctuation">:</span>
      <span class="token key atrule">store</span><span class="token punctuation">:</span> inmemory
  <span class="token key atrule">replication_factor</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">path_prefix</span><span class="token punctuation">:</span> /tmp/loki

<span class="token key atrule">schema_config</span><span class="token punctuation">:</span>
  <span class="token key atrule">configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span> <span class="token datetime number">2020-05-15</span>
    <span class="token key atrule">store</span><span class="token punctuation">:</span> tsdb
    <span class="token key atrule">object_store</span><span class="token punctuation">:</span> filesystem
    <span class="token key atrule">schema</span><span class="token punctuation">:</span> v13
    <span class="token key atrule">index</span><span class="token punctuation">:</span>
      <span class="token key atrule">prefix</span><span class="token punctuation">:</span> index_
      <span class="token key atrule">period</span><span class="token punctuation">:</span> 24h

<span class="token key atrule">storage_config</span><span class="token punctuation">:</span>
  <span class="token key atrule">filesystem</span><span class="token punctuation">:</span>
    <span class="token key atrule">directory</span><span class="token punctuation">:</span> /tmp/loki/chunks
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,1),G={href:"https://grafana.com/docs/loki/latest/send-data/promtail/configuration/",target:"_blank",rel:"noopener noreferrer"},E=t(`<div class="language-yaml line-numbers-mode" data-ext="yml"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">http_listen_port</span><span class="token punctuation">:</span> <span class="token number">9080</span>
  <span class="token key atrule">grpc_listen_port</span><span class="token punctuation">:</span> <span class="token number">0</span>
<span class="token key atrule">positions</span><span class="token punctuation">:</span>
  <span class="token key atrule">filename</span><span class="token punctuation">:</span> /home/zhangjf/positions.yaml
<span class="token key atrule">clients</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3100/loki/api/v1/push <span class="token comment"># loki推送log地址</span>
<span class="token key atrule">scrape_configs</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> system
  <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> localhost <span class="token comment"># 目标设置本机</span>
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
      <span class="token key atrule">job</span><span class="token punctuation">:</span> loki
      <span class="token key atrule">__path__</span><span class="token punctuation">:</span> /home/zhangjf/loki.log <span class="token comment"># loki进程的日志文件地址</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="启动" tabindex="-1"><a class="header-anchor" href="#启动" aria-hidden="true">#</a> 启动</h2><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">nohup</span> ./loki-linux-amd64 <span class="token parameter variable">-config.file</span><span class="token operator">=</span>loki.yaml <span class="token operator">&gt;</span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>loki.log <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>
<span class="token function">nohup</span> ./promtail-linux-amd64 <span class="token parameter variable">-config.file</span><span class="token operator">=</span>promtail.yaml <span class="token operator">&gt;</span> promtail.log <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="可视化" tabindex="-1"><a class="header-anchor" href="#可视化" aria-hidden="true">#</a> 可视化</h2><p>在Grafana原生支持Loki数据源，在web页面添加</p><figure><img src="`+r+'" alt="Grafana" tabindex="0" loading="lazy"><figcaption>Grafana</figcaption></figure><p>然后添加一个dashboard，通过Import 的方式添加，id：13639</p><figure><img src="'+c+'" alt="dashboard" tabindex="0" loading="lazy"><figcaption>dashboard</figcaption></figure><p>导入成功后可以看到日志数据成功展示出来了</p><figure><img src="'+u+'" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>',10);function P(j,K){const s=o("ExternalLinkIcon");return i(),p("div",null,[k,m,n("blockquote",null,[v,n("p",null,[n("a",h,[a("Loki"),e(s)])]),n("p",null,[n("a",b,[a("promtail"),e(s)])]),n("p",null,[n("a",f,[a("grafana"),e(s)])])]),g,n("p",null,[n("a",_,[a("Loki安装包"),e(s)]),a("，"),n("a",y,[a("Promtail安装包"),e(s)])]),x,n("p",null,[a("Loki配置，可以参考"),n("a",L,[a("官网配置"),e(s)]),a("，有很多例子，这里我使用的是本地配置")]),z,n("p",null,[a("Promtail配置，也可以参考"),n("a",G,[a("官网配置"),e(s)]),a("，本次演示的配置如下")]),E])}const w=l(d,[["render",P],["__file","01.Grafana Loki Promtail日志收集.html.vue"]]);export{w as default};
